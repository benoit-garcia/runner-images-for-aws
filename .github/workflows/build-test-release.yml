name: Build Test Release
run-name: ${{ inputs.image_id }}

on:
  workflow_call:
    inputs:
      # e.g. ubuntu22-full-x64
      image_id:
        required: true
        type: string
    outputs:
      ami_name:
        description: "The name of the built AMI"
        value: ${{ jobs.build.outputs.ami_name }}
      ami_id:
        description: "The ID of the built AMI"
        value: ${{ jobs.build.outputs.ami_id }}

jobs:
  build:
    uses: ./.github/workflows/build.yml
    with:
      image_id: ${{ inputs.image_id }}
    secrets: inherit

  test:
    needs: build
    uses: ./.github/workflows/test.yml
    with:
      ami_id: ${{ needs.build.outputs.ami_id }}

  release:
    needs:
      - build
      - test
    uses: ./.github/workflows/release.yml
    secrets: inherit
    with:
      image_id: ${{ inputs.image_id }}
      ami_name: ${{ needs.build.outputs.ami_name }}